## Perl taint turned on!
# The web team warn us that "This will break things (subtly) if you ever run more than
# one website in the same Apache taint mode is actually next to useless and is better
# to disable it - it allows you to write good code rather than the bad code which taint
# forces you to write." (N.b. the modern 2013 Perl web world is much the same opinion 
# http://stackoverflow.com/questions/6166742/plack-taint-mode )
# However - we're leaving it on here, with this massive warning, as we're using the
# Clearpress framework which creates cgi with taint turned on and I'd rather run
# Clearpress  "within spec" than "outside spec".
PerlSwitches -T

#
# 0ne-component path to Apache Perl libraries ia added to the @INC array
#
PerlSwitches -I${MODPERL5LIB}

#
# 0ne-component PERL5LIB value is added to the @INC array
# Add another expression like this if more directories
# should be added to @INC
#
PerlSwitches -I${PERL5LIB}
PerlSwitches -I"${NPG_TRACKING_SERVER_PATH}/lib/perl5"

#
# Port as defined by the environment variable
#
Listen ${NPG_TRACKING_SERVER_PORT}

<VirtualHost _default_:${NPG_TRACKING_SERVER_PORT}>

  DocumentRoot ${NPG_TRACKING_SERVER_PATH}/htdocs

  CGIDScriptTimeout 100

  Alias /prodsoft/npg/ ${NPG_TRACKING_SERVER_PATH}/htdocs/
  Alias /css/          ${NPG_TRACKING_SERVER_PATH}/htdocs/css/
  Alias /icons/        ${NPG_TRACKING_SERVER_PATH}/htdocs/icons/

  #
  # Make staging directories content visible to this server
  #
  Alias "/nfs"	  "/nfs"
  Alias "/export"  "/export"
  <DirectoryMatch "^/(nfs|export)/(sf|gs)[0-9]+" >
    Options		Includes Indexes FollowSymLinks
    IndexOptions	FancyIndexing XHTML NameWidth=* 
    IndexOptions	ShowForbidden SuppressDescription SuppressIcon
    IndexOptions	FoldersFirst VersionSort
    IndexStyleSheet	"/css/dirindex.css"
    AllowOverride	None
    Require             all granted
  </DirectoryMatch>

  #
  # Disable access to (download of) some files.
  # Does not prevent them being listed in the directory view above.
  #
  <FilesMatch "\.(cif|dif|bcl|ba[im]|sam|fastq|fq|cra[im]|bed(pe)?|vcf)(\.(gz|xz|bz2))?$">
    Require             all denied
  </FilesMatch>

  #
  # Allow access to document root
  #
  <Directory  ${NPG_TRACKING_SERVER_PATH}/htdocs>
    Options		None
    AllowOverride	None
    Require             all granted
  </Directory>

  #
  # Uncomment the line starting with PerlPostConfigRequire if you prefer
  # to set up environment by executing an external script.
  #
  # The script might look like this:
  #
  #  #!/usr/bin/env perl
  #  use lib qw(some path);
  #  1;
  #
  #PerlPostConfigRequire "${NPG_TRACKING_SERVER_PATH}/wtsi_local/httpd_startup.pl"

  Alias "/perl/"  "${NPG_TRACKING_SERVER_PATH}/cgi-bin/"
  <Location /perl/>
    SetHandler          perl-script
    Options             +ExecCGI
    Require             all granted
    PerlResponseHandler ModPerl::Registry
    PerlSendHeader      On
    PerlOptions         +ParseHeaders -SetupEnv
    PerlSetEnv          dev           ${dev}
    PerlSetEnv          DBI_TRACE     0
    PerlSetEnv          NPG_DATA_ROOT ${NPG_TRACKING_SERVER_PATH}/data
  </Location>

  #
  # Redirect requests
  #
  RewriteEngine on
  # Redirect server root to NPG tracking main page
  RewriteRule   ^/$  /perl/npg  [R,L]

  #
  # This virtual host specific logs
  #
  ErrorLog  ${NPG_TRACKING_SERVER_LOGDIR}/npg_tracking_${NPG_TRACKING_SERVER_PORT}_${dev}_error.log
  CustomLog ${NPG_TRACKING_SERVER_LOGDIR}/npg_tracking_${NPG_TRACKING_SERVER_PORT}_${dev}_access.log combined

</VirtualHost>

